<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Mobile FPS STEP1</title>

<style>
html,body{
  margin:0; padding:0;
  overflow:hidden;
  background:#000;
  touch-action:none;
}
canvas{display:block}

/* UI */
#cross{
  position:fixed;
  left:50%; top:50%;
  width:18px; height:18px;
  margin:-9px;
  pointer-events:none;
}
#cross:before,#cross:after{
  content:""; position:absolute; background:#fff;
}
#cross:before{width:18px;height:2px;top:8px}
#cross:after{width:2px;height:18px;left:8px}

/* joystick */
#joy{
  position:fixed;
  left:20px; bottom:20px;
  width:120px; height:120px;
  border-radius:50%;
  background:rgba(255,255,255,0.15);
}
#stick{
  position:absolute;
  left:40px; top:40px;
  width:40px; height:40px;
  border-radius:50%;
  background:rgba(255,255,255,0.6);
}

/* fire */
#fire{
  position:fixed;
  right:30px; bottom:35px;
  width:90px; height:90px;
  border-radius:50%;
  background:#ff3333;
  opacity:0.6;
}
</style>
</head>

<body>
<canvas id="c"></canvas>
<div id="cross"></div>
<div id="joy"><div id="stick"></div></div>
<div id="fire"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
/* ===== THREE ===== */
const renderer=new THREE.WebGLRenderer({canvas:c,antialias:true});
renderer.setSize(innerWidth,innerHeight);

const scene=new THREE.Scene();
scene.background=new THREE.Color(0x111111);

const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,2000);

scene.add(new THREE.AmbientLight(0xffffff,0.8));
const sun=new THREE.DirectionalLight(0xffffff,0.6);
sun.position.set(10,20,10);
scene.add(sun);

/* ===== GRID MAP ===== */
const grid=new THREE.GridHelper(2000,200,0xaaaaaa,0x666666);
grid.material.opacity=0.4;
grid.material.transparent=true;
scene.add(grid);

/* ===== PLAYER ===== */
const player=new THREE.Object3D();
player.position.set(0,0,5);
scene.add(player);

/* ===== STATE ===== */
let moveX=0,moveY=0;
let yaw=0,pitch=0;
let ammo=6, maxAmmo=6;
let canShoot=true;
let recoil=0;

/* ===== AUDIO ===== */
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
function sound(freq,time){
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.frequency.value=freq;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+time);
  o.stop(audioCtx.currentTime+time);
}

/* ===== JOYSTICK ===== */
const joy=document.getElementById("joy");
const stick=document.getElementById("stick");

joy.addEventListener("touchmove",e=>{
  e.preventDefault();
  const t=e.touches[0];
  const r=joy.getBoundingClientRect();
  const dx=t.clientX-(r.left+r.width/2);
  const dy=t.clientY-(r.top+r.height/2);
  moveX=Math.max(-1,Math.min(1,dx/40));
  moveY=Math.max(-1,Math.min(1,dy/40));
  stick.style.transform=`translate(${moveX*30}px,${moveY*30}px)`;
},{passive:false});

joy.addEventListener("touchend",()=>{
  moveX=moveY=0;
  stick.style.transform="translate(0,0)";
});

/* ===== VIEW ROTATE ===== */
let lx=0,ly=0;
document.addEventListener("touchstart",e=>{
  if(e.touches[0].clientX<innerWidth/2)return;
  lx=e.touches[0].clientX;
  ly=e.touches[0].clientY;
});
document.addEventListener("touchmove",e=>{
  if(e.touches[0].clientX<innerWidth/2)return;
  e.preventDefault();
  const dx=e.touches[0].clientX-lx;
  const dy=e.touches[0].clientY-ly;
  lx=e.touches[0].clientX;
  ly=e.touches[0].clientY;
  yaw-=dx*0.005;
  pitch-=dy*0.005;
  pitch=Math.max(-1.2,Math.min(1.2,pitch));
},{passive:false});

/* ===== SHOOT ===== */
function shoot(){
  if(!canShoot)return;
  if(ammo<=0){
    reload();
    return;
  }
  canShoot=false;
  ammo--;
  sound(200,0.15);        // 발사음
  recoil+=0.08;           // 반동

  setTimeout(()=>canShoot=true,300);
}

function reload(){
  sound(80,0.4);          // 장전음
  setTimeout(()=>ammo=maxAmmo,700);
}

document.getElementById("fire").addEventListener("touchstart",shoot);

/* ===== LOOP ===== */
function loop(){
  requestAnimationFrame(loop);

  const speed=0.18;
  player.position.x+=(Math.sin(yaw)*moveY+Math.cos(yaw)*moveX)*speed;
  player.position.z+=(Math.cos(yaw)*moveY-Math.sin(yaw)*moveX)*speed;

  recoil*=0.9;
  camera.position.set(player.position.x,1.6,player.position.z);
  camera.rotation.set(pitch-recoil,yaw,0);

  renderer.render(scene,camera);
}
loop();
</script>
</body>
</html>